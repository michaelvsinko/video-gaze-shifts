# A estimator of gaze shifts

## Requirements:
- Mac OS / Linux (tested on Mac OS, Ubuntu and WSL2(Ubuntu) only)
- Python >=3.7,<3.10 (tested on 3.9.5 only)

<br>

Poetry:
```bash
poetry install
```

or pip (not tested, exported from poetry):

```bash
pip install -r requirements.txt
```

---

<br>

[Download](https://drive.google.com/uc?export=view&id=1GdE_-W5Wq9x2vqqplj23hxIiWTeExivx) model and move it to `video_gaze_shifts/blink_extraction_tf/eye_detect_vgg16.h5`

## Usage Example:
```python
import json

from video_gaze_shifts.runner import GazeRunner
from video_gaze_shifts.shift_estimator import tags_to_stats

runner = GazeRunner()

tags = []
for pitch, yaw, tag in runner.forward(
    path="./examples/input_1.mp4",
    mode="video",
    output_path="./examples/output_1.mp4",
    visualize=True,
):
    tags.append(tag)

stats = tags_to_stats(tags=tags)

with open("./examples/output_1.json", "w") as f:
    json.dump(stats, f, indent=4)
```

[notebook](https://github.com/michaelvsinko/video-gaze-shifts/examples/notebook.ipynb)

---

<br>

## Results

![video1 result](https://drive.google.com/uc?export=view&id=1qq75LeWmIhuKyHM_v1qK8zIiweDMuM7D)
![video1 result](https://drive.google.com/uc?export=view&id=12K6v8DOgg75Kee449jmmyeHWqh-_wkR5)

[Пример выходного json](examples/output_1.json) | [Пример выходного json](examples/output_2.json)

---

<br>

## Description

### Задание:

Взгляд человека относительно центра может переходить в 6 областей. Лево вверх, лево в бок, в лево низ, право низ, право бок, право вверх.

Необходимо написать скрипт, который производит подсчёт следующих параметров:
- [x] Количество отклонений взгляда от центра (`total_num_shifts` в сгенерированном dict/json)
- [x] Частота отклонений от центра (`freq_secs_shift_from_center` - частота отклонений от центра, `mean_secs_wo_shift_per_tag` - среднее количество секунд без отклонений по тегам)
- [x] Длительность отклонений от центра (`per_tag_time_sec`)
- [x] Переходы из одной области в другую (`per_shift_times` - кол-во, `per_shift_norm_times` - относительное кол-во)
- [x] Есть ли области, в которые не направлялся взгляд, если да, то какие (`unused_tags`)
- [x] Процентное соотношение переходов (`per_shift_norm_times`)
- [x] Среднее время нахождение взгляда в области (`per_tag_mean_time_sec`)

---

Если есть необходимость, можно выделить 2 доп области: вверх и вниз относительно центра. Если не какой-то из параметров не удаться реализовать, переходите к следующему. Отдельным плюсом будет, если вы придумаете свой параметр и реализуете его подсчёт. Так же будет хорошо если будет сделана визуализация (выделение областей и вектор взгляда, например).
Как устанавливать границы областей решаете вы сами.

Крайний срок сдачи понедельник (08.11) 11:00. Если по какой-то причине будете не успевать сделать, но будет желание закончить  задание предупредите.

---

<br>

### Описание

* В качестве модели для обнаружения лица и разметки лендмарков используется [MediaPipe](https://github.com/google/mediapipe) от Google [(Paper)](https://arxiv.org/abs/2007.15837)
* В качестве модели для предсказания вектора взгляда используется [ETH-XGaze](https://github.com/xucong-zhang/ETH-XGaze) [(Paper)](https://arxiv.org/abs/2007.15837) с предобученным backbone `ResNet18`
* Модель предсказывает углы наклона (pitch, yaw) взгляда относительно видео/изображения, однако использовать данные углы не самый оптимальный способ, так как не учитывается угол наклона/поворота головы. Для исправления этого, полученные углы наклона взгляда были нормализованы относительно наклона координатных осей головы
* В результате предыдущего, `уголы наклона взгляда показывают наклон относительно лица, а не видео/изображения`
* Аналогично, `области, на которые направлен взгяд, показывают области относительно лица, а не области экрана или камеры`
* Дополнительно к предыдущему, `правые области - правые относительно лица человека, а не относительно камеры`
* Кроме того, благодаря этому, решение не зависит от местоположения лица в кадре
* Области, на которые направлен взгяд пользователя, поделены на круглую центральную и 6 областей отклонений:
    * Центральная область - область отклонения меньше чем на 10 градусов по pitch и yaw от центра (центр = центр носа)
    * yaw > 0 - право относительно лица, yaw < 0 - лево
    * верх-центр-низ отрезаются линиями на -45, +45, выходящими из центра круга, за областью круга
* Для вычисления переходов, времени в области и частоты отклонений - набор `область per frame` сглаживается окном в 15 фреймов
* Учитываются и отсеиваются моргания

---

<br>

### Текущие ограничения и как исправить

- [ ] ???

---

<br>

### TODO:

- [ ] Переписать покадровое чтение и обработку на батчинг
- [ ] Переписать и поделить код нормально, уменьшить complexity, убрать пропущенные проверки из .flake8
- [ ] CLI
- [ ] ResNet18 слабая модель, стоит переучить что-то нормальное
- [ ] Для обнаружения лица, предсказания вектора взгляда и предсказания моргания используются разные модели (еще и на разных фреймворках), хотя все можно решить одной мульти-такс
